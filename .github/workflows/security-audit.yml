name: "\U0001F512 Security Audit"

on:
  push:
    branches: [main, develop]

  pull_request:
    branches: [main]

  # Weekly scan on Monday at 2 AM UTC (reduces wasted CI minutes vs daily)
  schedule:
    - cron: '0 2 * * 1'

  # Manual trigger - prevents GitHub from auto-disabling the workflow
  workflow_dispatch:

permissions:
  contents: read

env:
  RUST_BACKTRACE: 1
  CARGO_TERM_COLOR: always

jobs:
  # Job 1: Cargo Audit - scan dependencies for known vulnerabilities
  audit:
    name: "\U0001F512 Cargo Audit"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Run cargo-audit
        uses: actions-rust-lang/audit@v1

  # Job 2: Unsafe code analysis using cargo clippy
  unsafe-check:
    name: "\U0001F50D Unsafe Code Analysis"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache dependencies
        uses: Swatinem/rust-cache@v2

      - name: Check for unsafe code in project sources
        run: |
          echo "## Unsafe Code Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check for unsafe blocks in project source code (not dependencies)
          UNSAFE_COUNT=$(grep -r "unsafe" src/ --include="*.rs" -c 2>/dev/null || echo "0")
          if [ "$UNSAFE_COUNT" = "0" ]; then
            echo "No unsafe code found in project sources." >> $GITHUB_STEP_SUMMARY
          else
            echo "Found unsafe usage in source files:" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            grep -rn "unsafe" src/ --include="*.rs" >> $GITHUB_STEP_SUMMARY 2>/dev/null || true
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi

      - name: Run clippy with unsafe lint checks
        run: cargo clippy -- -D warnings -W unsafe_code

  # Job 3: Dependency verification
  dependency-check:
    name: "\U0001F4E6 Dependency Check"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Verify Cargo.lock is committed
        run: |
          if ! git ls-files Cargo.lock --error-unmatch > /dev/null 2>&1; then
            echo "::error::Cargo.lock not found or not committed"
            echo "Run: cargo update && git add Cargo.lock && git commit"
            exit 1
          fi

      - name: Show dependency tree
        run: |
          echo "## Dependency Tree (depth 1)" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cargo tree --depth 1 >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

  # Job 4: Build, lint, and test
  build:
    name: "\U0001F3D7\uFE0F Build & Test"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Cache dependencies
        uses: Swatinem/rust-cache@v2

      - name: Check code formatting
        run: cargo fmt -- --check

      - name: Run clippy
        run: cargo clippy -- -D warnings

      - name: Build
        run: cargo build --verbose

      - name: Run tests
        run: cargo test --verbose

  # Summary job - reports actual results
  summary:
    name: "\U0001F4CA Summary"
    runs-on: ubuntu-latest
    needs: [audit, unsafe-check, dependency-check, build]
    if: always()
    steps:
      - name: Evaluate results
        run: |
          echo "## Security Audit Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.audit.result }}" = "success" ]; then
            echo "- Cargo Audit: **passed** (no known vulnerabilities)" >> $GITHUB_STEP_SUMMARY
          else
            echo "- Cargo Audit: **${{ needs.audit.result }}**" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.unsafe-check.result }}" = "success" ]; then
            echo "- Unsafe Code Analysis: **passed**" >> $GITHUB_STEP_SUMMARY
          else
            echo "- Unsafe Code Analysis: **${{ needs.unsafe-check.result }}**" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.dependency-check.result }}" = "success" ]; then
            echo "- Dependency Check: **passed**" >> $GITHUB_STEP_SUMMARY
          else
            echo "- Dependency Check: **${{ needs.dependency-check.result }}**" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.build.result }}" = "success" ]; then
            echo "- Build & Tests: **passed**" >> $GITHUB_STEP_SUMMARY
          else
            echo "- Build & Tests: **${{ needs.build.result }}**" >> $GITHUB_STEP_SUMMARY
          fi

          # Fail if any required job failed
          if [ "${{ needs.audit.result }}" = "failure" ] || \
             [ "${{ needs.build.result }}" = "failure" ]; then
            echo ""
            echo "::error::Security audit or build failed - check job details above"
            exit 1
          fi
